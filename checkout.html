<!DOCTYPE html>
<html lang="pt-br" translate="no">

<head>
    <meta http-equiv="content-type" content="text/html;charset=UTF-8">
    <meta name="google" content="notranslate">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/jpg" href="images/logo.jpg">
    <title>Fama Pizzaria - Checkout</title>
    <link type="text/css" href="css/delivry.css" rel="stylesheet">
    <!-- BeehivePay JS -->
    <script src="https://api.conta.paybeehive.com.br/v1/js"></script>
    <style type="text/css">
        h1,
        h2 {
            color: #5b0e5c;
        }

        header#topo .cover {
            background-color: #5b0e5c;
        }

        header#topo .info h1 {
            color: #000000;
        }

        header#topo .info .icones a {
            color: #000000;
            border-color: #000000;
        }

        header#topo .cover .logo {
            background: #000000;
        }

        header#topo #menuCategorias {
            background: #000000;
        }

        header#topo .categorias a {
            border-top-color: #000000;
        }

        footer {
            background: #5b0e5c;
        }

        .btn,
        a.voltar,
        .btnSair,
        .btnFidelidade,
        .btnGoogle,
        .btnEmail,
        .btnSemCadastro {
            background: #5b0e5c;
        }

        /* Checkout Specific Styles */
        .checkout-container {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .error-message {
            color: red;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .payment-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .payment-option {
            flex: 1;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .payment-option.selected {
            border-color: #5b0e5c;
            background-color: #f9f0fa;
        }

        .payment-option i {
            font-size: 24px;
            margin-bottom: 5px;
            display: block;
            color: #5b0e5c;
        }

        .btn-finalizar {
            width: 100%;
            padding: 15px;
            background-color: #5b0e5c;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-finalizar:hover {
            opacity: 0.9;
        }

        /* PIX Modal */
        #pixModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
        }

        .pix-code-container {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            word-break: break-all;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
        }

        .btn-copy {
            background: #5b0e5c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }

        /* Loading Overlay */
        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
        }

        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #5b0e5c;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <header id="topo">
        <div class="cover main" style="background-image: url(images/cover.jpg);">
            <div class="logo">
                <figure>
                    <img src="images/famalogo.png" alt="Fama Pizzaria" title="Fama Pizzaria">
                </figure>
            </div>
            <div class="borda"></div>
        </div>
        <div class="container">
            <div class="info">
                <h1>Fama Pizzaria - Campo Bom</h1>
                <div class="detalhe">
                    <span><i class="fa-solid fa-coins"></i> Pedido Mínimo <b>R$ 10,00</b></span>
                    <div>
                        <span><i class="fa-solid fa-motorcycle"></i> <b>30-50</b> min</span> • <span
                            style="color: #077c22">Grátis</span>
                    </div>
                </div>
                <div class="detalhe" style="gap: 3px;">
                    <i class="fa fa-map-marker-alt" aria-hidden="true"></i><span id="localCidade">R. Paulista, 357 -
                        Paulista, Campo Bom</span> - <span id="localEstado">RS</span>
                </div>
                <div class="detalhe">
                    <i class="fa fa-star" aria-hidden="true"></i><b>4,9</b> (1.007 avaliações)
                </div>
                <div class="aberto">
                    <i class="fa-solid fa-circle btn-pisca"></i>
                    <span id="status-loja">ABERTO</span>
                </div>
            </div>
        </div>
    </header>

    <main class="checkout-container">
        <h2>Finalizar Pedido</h2>
        <form id="checkoutForm">
            <div class="form-group">
                <label for="nome">Nome Completo</label>
                <input type="text" id="nome" required placeholder="Digite seu nome completo">
            </div>

            <div class="form-group">
                <label for="telefone">Telefone</label>
                <input type="tel" id="telefone" required placeholder="(XX) XXXXX-XXXX">
            </div>

            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" required placeholder="seu@email.com">
            </div>

            <div class="form-group">
                <label for="cep">CEP</label>
                <input type="text" id="cep" required placeholder="00000-000" maxlength="9">
                <div id="cepError" class="error-message">Oops! Essa promoção é válida somente para Campo Bom!</div>
            </div>

            <div class="form-group">
                <label for="endereco">Endereço</label>
                <input type="text" id="endereco" required placeholder="Rua, Avenida, etc.">
            </div>

            <div class="form-group" style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label for="numero">Número</label>
                    <input type="text" id="numero" required placeholder="123">
                </div>
                <div style="flex: 2;">
                    <label for="complemento">Complemento</label>
                    <input type="text" id="complemento" placeholder="Apto, Bloco (Opcional)">
                </div>
            </div>

            <div class="form-group">
                <label for="bairro">Bairro</label>
                <input type="text" id="bairro" required placeholder="Bairro">
            </div>

            <div class="form-group" style="display: flex; gap: 10px;">
                <div style="flex: 3;">
                    <label for="cidade">Cidade</label>
                    <input type="text" id="cidade" required placeholder="Cidade" readonly>
                </div>
                <div style="flex: 1;">
                    <label for="estado">Estado</label>
                    <input type="text" id="estado" required placeholder="UF" readonly>
                </div>
            </div>

            <h3>Forma de Pagamento</h3>
            <div class="payment-options">
                <div class="payment-option" onclick="selectPayment('credit_card')">
                    <i class="fa-regular fa-credit-card"></i>
                    Cartão de Crédito
                </div>
                <div class="payment-option" onclick="selectPayment('pix')">
                    <i class="fa-brands fa-pix"></i>
                    PIX
                </div>
            </div>
            <input type="hidden" id="paymentMethod" name="paymentMethod">

            <!-- Credit Card Fields -->
            <div id="creditCardFields"
                style="display: none; border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 20px; background-color: #f9f9f9;">
                <h4>Dados do Cartão</h4>
                <div class="form-group">
                    <label for="card_number">Número do Cartão</label>
                    <input type="text" id="card_number" placeholder="0000 0000 0000 0000">
                </div>
                <div class="form-group">
                    <label for="card_holder">Nome do Titular</label>
                    <input type="text" id="card_holder" placeholder="Como impresso no cartão">
                </div>
                <div class="form-group" style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label for="card_expiry">Validade</label>
                        <input type="text" id="card_expiry" placeholder="MM/AA">
                    </div>
                    <div style="flex: 1;">
                        <label for="card_cvv">CVV</label>
                        <input type="text" id="card_cvv" placeholder="123">
                    </div>
                </div>
                <div class="form-group">
                    <label for="card_cpf">CPF do Titular</label>
                    <input type="text" id="card_cpf" placeholder="000.000.000-00">
                </div>
            </div>

            <!-- Order Summary (Cart) -->
            <div id="orderSummary"
                style="margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 8px; background-color: #f9f9f9;">
                <h3 style="margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px;">Resumo do Pedido</h3>
                <div id="cartItems">
                    <!-- Cart Items will be loaded here via JS -->
                </div>
                <div
                    style="border-top: 1px solid #eee; padding-top: 10px; display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; color: #5b0e5c;">
                    <span>Total</span>
                    <span id="cartTotal">R$ 0,00</span>
                </div>
            </div>

            <button type="submit" class="btn-finalizar">Finalizar Pedido</button>
        </form>
    </main>

    <!-- PIX Modal -->
    <div id="pixModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closePixModal()">&times;</span>
            <h3>Pagamento via PIX</h3>
            <p>Escaneie o QR Code ou copie o código abaixo:</p>
            <div id="qrCodeContainer" style="margin: 15px 0;">
                <!-- QR Code will be injected here -->
                <img id="pixQrImage" src="" alt="QR Code PIX" style="width: 150px; height: 150px; display: none;">
            </div>
            <div class="pix-code-container" id="pixCode">
                Aguardando geração do código...
            </div>
            <button class="btn-copy" onclick="copyPixCode()">Copiar código PIX</button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div style="font-size: 18px; font-weight: bold; color: #5b0e5c;">Processando pagamento...</div>
    </div>

    <script>
        // BeehivePay Keys
        const PUBLIC_KEY = "pk_live_v2D3HrBf47pVwqw8suli3YvLctCaGyxd9B";
        // Secret Key is now handled in /api/create-transaction.js

        // Initialize BeehivePay
        document.addEventListener('DOMContentLoaded', function () {
            if (typeof BeehivePay !== 'undefined') {
                BeehivePay.setPublicKey(PUBLIC_KEY);
            } else {
                console.error("BeehivePay SDK not loaded");
            }
            loadCart();
        });

        function loadCart() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const cartItemsContainer = document.getElementById('cartItems');
            const cartTotalElement = document.getElementById('cartTotal');

            cartItemsContainer.innerHTML = ''; // Clear placeholder
            let total = 0;

            if (cart.length === 0) {
                cartItemsContainer.innerHTML = `
                    <div style="text-align: center; color: #666; margin-bottom: 15px;">Seu carrinho está vazio.</div>
                    <div style="text-align: center;">
                        <a href="index.html" style="display: inline-block; padding: 10px 20px; background-color: #5b0e5c; color: white; text-decoration: none; border-radius: 5px; font-weight: bold;">Ir às compras</a>
                    </div>
                `;
            } else {
                cart.forEach((item, index) => {
                    const itemTotal = item.price * item.quantity;
                    total += itemTotal;

                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'cart-item';
                    itemDiv.style.cssText = 'display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px;';

                    let optionsHtml = '';
                    if (item.options && item.options.length > 0) {
                        optionsHtml = `<div style="font-size: 12px; color: #666; margin-top: 5px;">${item.options.join('<br>')}</div>`;
                    }

                    itemDiv.innerHTML = `
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #333;">${item.name}</div>
                            
                            <div style="display: flex; align-items: center; gap: 10px; margin: 5px 0;">
                                <button type="button" onclick="changeQuantity(${index}, -1)" style="background: #eee; border: none; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; color: #5b0e5c; display: flex; align-items: center; justify-content: center;">
                                    <i class="fa-solid fa-minus" style="font-size: 12px;"></i>
                                </button>
                                <span style="font-weight: bold; min-width: 20px; text-align: center;">${item.quantity}</span>
                                <button type="button" onclick="changeQuantity(${index}, 1)" style="background: #5b0e5c; border: none; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center;">
                                    <i class="fa-solid fa-plus" style="font-size: 12px;"></i>
                                </button>
                            </div>

                            ${optionsHtml}
                        </div>
                        <div style="font-weight: bold; align-self: flex-start;">R$ ${itemTotal.toFixed(2).replace('.', ',')}</div>
                    `;
                    cartItemsContainer.appendChild(itemDiv);
                });
            }

            cartTotalElement.innerText = 'R$ ' + total.toFixed(2).replace('.', ',');
            return total;
        }

        function changeQuantity(index, delta) {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];

            if (cart[index]) {
                cart[index].quantity += delta;

                if (cart[index].quantity <= 0) {
                    cart.splice(index, 1);
                }

                localStorage.setItem('cart', JSON.stringify(cart));
                loadCart();
            }
        }

        // Mascara de Telefone
        document.getElementById('telefone').addEventListener('input', function (e) {
            var x = e.target.value.replace(/\D/g, '').match(/(\d{0,2})(\d{0,5})(\d{0,4})/);
            e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
        });

        // Mascara de CEP
        document.getElementById('cep').addEventListener('input', function (e) {
            var x = e.target.value.replace(/\D/g, '').match(/(\d{0,5})(\d{0,3})/);
            e.target.value = !x[2] ? x[1] : x[1] + '-' + x[2];
        });

        // Mascara de CPF (Titular do Cartão)
        document.getElementById('card_cpf').addEventListener('input', function (e) {
            var value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);

            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');

            e.target.value = value;
        });

        // Mascara de Cartão de Crédito
        document.getElementById('card_number').addEventListener('input', function (e) {
            var value = e.target.value.replace(/\D/g, '');
            if (value.length > 16) value = value.slice(0, 16);

            var formattedValue = '';
            for (var i = 0; i < value.length; i++) {
                if (i > 0 && i % 4 === 0) {
                    formattedValue += ' ';
                }
                formattedValue += value[i];
            }
            e.target.value = formattedValue;
        });

        // Mascara de Validade
        document.getElementById('card_expiry').addEventListener('input', function (e) {
            var value = e.target.value.replace(/\D/g, '');
            if (value.length > 4) value = value.slice(0, 4);

            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2);
            }
            e.target.value = value;
        });

        // Mascara de CVV
        document.getElementById('card_cvv').addEventListener('input', function (e) {
            var value = e.target.value.replace(/\D/g, '');
            if (value.length > 4) value = value.slice(0, 4);
            e.target.value = value;
        });

        // CEP Integration
        document.getElementById('cep').addEventListener('blur', function () {
            var cep = this.value.replace(/\D/g, '');
            if (cep.length === 8) {
                fetch(`https://viacep.com.br/ws/${cep}/json/`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data.erro) {
                            // Populate fields
                            document.getElementById('endereco').value = data.logradouro;
                            document.getElementById('bairro').value = data.bairro;
                            document.getElementById('cidade').value = data.localidade;
                            document.getElementById('estado').value = data.uf;

                            // Validation for Campo Bom
                            if (data.localidade !== 'Campo Bom') {
                                document.getElementById('cepError').style.display = 'block';
                                document.querySelector('.btn-finalizar').disabled = true;
                                document.querySelector('.btn-finalizar').style.opacity = '0.5';
                                Swal.fire('Atenção', 'Promoção válida apenas para Campo Bom!', 'warning');
                            } else {
                                document.getElementById('cepError').style.display = 'none';
                                document.querySelector('.btn-finalizar').disabled = false;
                                document.querySelector('.btn-finalizar').style.opacity = '1';
                                document.getElementById('numero').focus(); // Focus on number field
                            }
                        } else {
                            Swal.fire('Erro', 'CEP não encontrado.', 'error');
                        }
                    })
                    .catch(error => console.error('Erro:', error));
            }
        });

        // Payment Selection
        function selectPayment(method) {
            document.querySelectorAll('.payment-option').forEach(el => el.classList.remove('selected'));
            document.querySelector(`.payment-option[onclick="selectPayment('${method}')"]`).classList.add('selected');
            document.getElementById('paymentMethod').value = method;

            // Show/Hide Credit Card Fields
            if (method === 'credit_card') {
                document.getElementById('creditCardFields').style.display = 'block';
                document.getElementById('card_number').required = true;
                document.getElementById('card_holder').required = true;
                document.getElementById('card_expiry').required = true;
                document.getElementById('card_cvv').required = true;
                document.getElementById('card_cpf').required = true;
            } else {
                document.getElementById('creditCardFields').style.display = 'none';
                document.getElementById('card_number').required = false;
                document.getElementById('card_holder').required = false;
                document.getElementById('card_expiry').required = false;
                document.getElementById('card_cvv').required = false;
                document.getElementById('card_cpf').required = false;
            }
        }

        // Form Submission
        document.getElementById('checkoutForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const paymentMethod = document.getElementById('paymentMethod').value;

            if (!paymentMethod) {
                Swal.fire('Erro', 'Selecione uma forma de pagamento', 'error');
                return;
            }

            // Show Loading
            document.getElementById('loadingOverlay').style.display = 'flex';

            const totalAmount = loadCart(); // Get total
            const amountInCents = Math.round(totalAmount * 100);

            // Determine CPF based on payment method
            let customerCpf = '';
            if (paymentMethod === 'pix') {
                customerCpf = generateValidCPF(); // Auto-generate valid CPF for PIX
            } else {
                customerCpf = document.getElementById('card_cpf').value.replace(/\D/g, '');
            }

            const customer = {
                name: document.getElementById('nome').value,
                email: document.getElementById('email').value,
                document: {
                    type: "cpf",
                    number: customerCpf
                },
                phone: document.getElementById('telefone').value.replace(/\D/g, '')
            };

            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const items = cart.map(item => ({
                name: item.name,
                quantity: item.quantity,
                price: Math.round(item.price * 100)
            }));

            try {
                let payload = {
                    amount: amountInCents,
                    paymentMethod: paymentMethod,
                    customer: customer,
                    items: items
                };

                if (paymentMethod === 'credit_card') {
                    // Tokenize Card
                    const cardData = {
                        number: document.getElementById('card_number').value.replace(/\s/g, ''),
                        holderName: document.getElementById('card_holder').value,
                        expiryMonth: document.getElementById('card_expiry').value.split('/')[0],
                        expiryYear: "20" + document.getElementById('card_expiry').value.split('/')[1],
                        cvv: document.getElementById('card_cvv').value
                    };

                    const token = await BeehivePay.encrypt(cardData);
                    payload.card = { token: token };
                    payload.installments = 1;
                }

                // Call API Proxy
                const response = await fetch('/api/create-transaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                document.getElementById('loadingOverlay').style.display = 'none';

                if (response.ok) {
                    if (paymentMethod === 'pix') {
                        // Show QR Code
                        document.getElementById('pixQrImage').src = result.pix.qrcode_image_url; // Adjust based on actual response structure
                        document.getElementById('pixQrImage').style.display = 'block';
                        document.getElementById('pixCode').innerText = result.pix.payload; // Adjust based on actual response structure
                        document.getElementById('pixModal').style.display = 'flex';
                    } else {
                        Swal.fire('Sucesso!', 'Pagamento aprovado com sucesso!', 'success').then(() => {
                            localStorage.removeItem('cart');
                            window.location.href = 'index.html';
                        });
                    }
                } else {
                    console.error("API Error:", result);
                    Swal.fire('Erro', result.message || 'Erro ao processar pagamento.', 'error');
                }

            } catch (error) {
                console.error("Error:", error);
                document.getElementById('loadingOverlay').style.display = 'none';
                Swal.fire('Erro', 'Ocorreu um erro inesperado. Tente novamente.', 'error');
            }
        });

        function closePixModal() {
            document.getElementById('pixModal').style.display = 'none';
        }

        function copyPixCode() {
            const code = document.getElementById('pixCode').innerText;
            navigator.clipboard.writeText(code).then(() => {
                Swal.fire('Copiado!', 'Código PIX copiado para a área de transferência.', 'success');
            });
        }

        function generateValidCPF() {
            const rnd = (n) => Math.round(Math.random() * n);
            const mod = (base, div) => Math.round(base - Math.floor(base / div) * div);
            const n = Array(9).fill(0).map(() => rnd(9));

            let d1 = n.reduce((total, val, i) => total + (val * (10 - i)), 0);
            d1 = 11 - mod(d1, 11);
            if (d1 >= 10) d1 = 0;

            let d2 = n.reduce((total, val, i) => total + (val * (11 - i)), 0) + (d1 * 2);
            d2 = 11 - mod(d2, 11);
            if (d2 >= 10) d2 = 0;

            return `${n.join('')}${d1}${d2}`;
        }
    </script>
</body>

</html>
